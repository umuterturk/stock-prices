<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEFAS Fund Data</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .control-group {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
            min-width: 80px;
        }

        .control-group input, .control-group select {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .fund-card {
            padding: 30px;
            text-align: center;
        }

        .fund-not-found {
            color: #dc3545;
            font-size: 1.1rem;
            padding: 30px;
            text-align: center;
        }

        .fund-code {
            font-size: 2rem;
            font-weight: 700;
            color: #343a40;
            margin-bottom: 10px;
        }

        .fund-name {
            font-size: 1rem;
            color: #6c757d;
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .price-section {
            margin: 30px 0;
        }

        .price-label {
            font-size: 1rem;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .price-value {
            font-size: 3rem;
            font-weight: 700;
            color: #28a745;
            margin-bottom: 5px;
        }

        .currency {
            font-size: 1.5rem;
            color: #6c757d;
        }

        .fund-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .detail-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .detail-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #343a40;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
        }

        .date-info {
            text-align: center;
            padding: 20px;
            background: #e9ecef;
            color: #495057;
            font-size: 0.9rem;
        }

        .disclaimer {
            background: #f8f9fa;
            border-top: 2px solid #dee2e6;
            padding: 25px;
            margin-top: 20px;
            font-size: 0.85rem;
            color: #6c757d;
            line-height: 1.6;
        }

        .disclaimer h4 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1rem;
            font-weight: 600;
        }

        .disclaimer p {
            margin-bottom: 10px;
        }

        .disclaimer .data-source {
            font-weight: 600;
            color: #495057;
        }

        .disclaimer .warning-text {
            color: #dc3545;
            font-weight: 500;
        }

        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 15px 20px;
            margin: 0 20px;
            border-radius: 8px;
            border: 1px solid #ffeaa7;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .warning-message::before {
            content: "⚠️";
            font-size: 1.2rem;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .price-value {
                font-size: 2.5rem;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group label {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>TEFAS Fund Data</h1>
            <p>Turkish Investment Funds Price Information</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="fundCode">Fund Code:</label>
                <input type="text" id="fundCode" placeholder="Enter fund code (e.g., TI2)" value="">
            </div>
            <div class="control-group">
                <label for="fundDate">Date:</label>
                <input type="date" id="fundDate" value="">
            </div>
        </div>

        <div id="content">
            <div class="loading">
                <p>Enter a fund code to view data (date is optional)</p>
            </div>
        </div>

        <div class="date-info">
            <p>Data is updated daily. Latest available date: <span id="latestDate">Loading...</span></p>
        </div>
    </div>

    <div class="disclaimer">
        <h4>Disclaimer & Data Source</h4>
        <p><span class="data-source">Data Source:</span> All fund data is sourced from the official TEFAS (Turkish Investment Funds Association) API at <strong>www.tefas.gov.tr</strong></p>
        <p><span class="data-source">API Endpoint:</span> https://www.tefas.gov.tr/api/DB/BindHistoryInfo</p>
        <p><span class="warning-text">Investment Warning:</span> This data is provided for informational purposes only and should not be considered as investment advice. Past performance does not guarantee future results.</p>
        <p><span class="warning-text">Accuracy Disclaimer:</span> While we strive to provide accurate and up-to-date information, we cannot guarantee the completeness or accuracy of the data. Please verify all information with official TEFAS sources before making investment decisions.</p>
        <p><span class="data-source">Update Frequency:</span> Data is typically updated daily based on TEFAS reporting schedules. Market holidays and weekends may affect data availability.</p>
        <p><span class="data-source">Technical Note:</span> Average portfolio per user is calculated as Total Portfolio Size ÷ Number of Investors. This represents the average investment amount per participant in the fund.</p>
    </div>

    <script>
        class TefasFundViewer {
            constructor() {
                this.fundCodeInput = document.getElementById('fundCode');
                this.fundDateInput = document.getElementById('fundDate');
                this.contentDiv = document.getElementById('content');
                this.latestDateSpan = document.getElementById('latestDate');
                
                this.init();
            }

            init() {
                // Parse URL parameters first
                this.parseUrlParams();
                
                // Set today's date as default only if no date was provided in URL
                if (!this.fundDateInput.value) {
                    const today = new Date().toISOString().split('T')[0];
                    this.fundDateInput.value = today;
                }
                
                // Add event listeners
                this.fundCodeInput.addEventListener('input', () => this.handleInputChange());
                this.fundDateInput.addEventListener('change', () => this.handleInputChange());
                
                // Load initial data if we have parameters
                if (this.fundCodeInput.value) {
                    this.loadFundData();
                }
                
                // Load latest date info
                this.loadLatestDate();
            }

            parseUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const date = urlParams.get('date');
                
                if (code) {
                    this.fundCodeInput.value = code.toUpperCase();
                }
                
                if (date) {
                    this.fundDateInput.value = date;
                }
            }

            updateUrl() {
                const code = this.fundCodeInput.value.trim().toUpperCase();
                const date = this.fundDateInput.value;
                
                const url = new URL(window.location);
                
                if (code) {
                    url.searchParams.set('code', code);
                } else {
                    url.searchParams.delete('code');
                }
                
                if (date) {
                    url.searchParams.set('date', date);
                } else {
                    url.searchParams.delete('date');
                }
                
                window.history.pushState({}, '', url);
            }

            handleInputChange() {
                this.updateUrl();
                
                const code = this.fundCodeInput.value.trim();
                const date = this.fundDateInput.value;
                
                if (code) {
                    this.loadFundData();
                } else {
                    this.showMessage('Enter a fund code to view data');
                }
            }

            async loadLatestDate() {
                try {
                    const response = await fetch('./latest.json');
                    if (response.ok) {
                        const data = await response.json();
                        const codes = Object.keys(data);
                        if (codes.length > 0) {
                            const latestDate = data[codes[0]].date;
                            this.latestDateSpan.textContent = latestDate;
                        }
                    }
                } catch (error) {
                    this.latestDateSpan.textContent = 'Unknown';
                }
            }

            async loadFundData() {
                const code = this.fundCodeInput.value.trim().toUpperCase();
                const requestedDate = this.fundDateInput.value;
                
                if (!code) return;
                
                this.showLoading();
                
                try {
                    let result;
                    
                    if (requestedDate) {
                        // Try to find data for the requested date or go back up to 7 days
                        result = await this.findFundDataWithFallback(code, requestedDate);
                    } else {
                        // Use latest.json when no date is provided
                        result = await this.findFundDataFromLatest(code);
                    }
                    
                    if (result.found) {
                        this.displayFundData(result.data, result.actualDate);
                    } else {
                        this.showFundNotFound(code, requestedDate || 'latest');
                    }
                } catch (error) {
                    this.showError(`Error loading data: ${error.message}`);
                }
            }

            async findFundDataFromLatest(code) {
                try {
                    const response = await fetch('./latest.json');
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data[code]) {
                            return {
                                found: true,
                                data: data[code],
                                actualDate: data[code].date || 'latest'
                            };
                        }
                    }
                } catch (error) {
                    console.error('Error loading latest data:', error);
                }
                
                return { found: false };
            }

            async findFundDataWithFallback(code, requestedDate) {
                const maxDaysBack = 7; // Go back up to 1 week
                const requestedDateObj = new Date(requestedDate);
                
                for (let daysBack = 0; daysBack <= maxDaysBack; daysBack++) {
                    const checkDate = new Date(requestedDateObj);
                    checkDate.setDate(checkDate.getDate() - daysBack);
                    const checkDateStr = checkDate.toISOString().split('T')[0];
                    
                    try {
                        const jsonFilename = `${checkDateStr}.json`;
                        const response = await fetch(`./${jsonFilename}`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            
                            if (data[code]) {
                                return {
                                    found: true,
                                    data: data[code],
                                    actualDate: checkDateStr
                                };
                            }
                        }
                    } catch (error) {
                        // Continue to next date if this one fails
                        continue;
                    }
                }
                
                return { found: false };
            }

            displayFundData(fund, actualDate = null) {
                const price = parseFloat(fund.price).toFixed(6);
                const shares = this.formatNumber(fund.shares);
                const investors = this.formatNumber(fund.investors);
                const portfolioSize = this.formatCurrency(fund.portfolio_size);
                
                // Calculate average portfolio per user
                const avgPerUser = fund.investors > 0 ? fund.portfolio_size / fund.investors : 0;
                const avgPortfolioPerUser = this.formatCurrency(avgPerUser);
                
                // Generate warning message if data is from a different date
                const warningHtml = actualDate && actualDate !== this.fundDateInput.value ? 
                    `<div class="warning-message">Data shown is from ${actualDate} (requested date ${this.fundDateInput.value} not available)</div>` : '';
                
                this.contentDiv.innerHTML = `
                    ${warningHtml}
                    <div class="fund-card">
                        <div class="fund-code">${fund.code}</div>
                        <div class="fund-name">${fund.name}</div>
                        
                        <div class="price-section">
                            <div class="price-label">Current Price</div>
                            <div class="price-value">${price}</div>
                            <div class="currency">${fund.currency}</div>
                        </div>
                        
                        <div class="fund-details">
                            <div class="detail-item">
                                <div class="detail-label">Total Shares</div>
                                <div class="detail-value">${shares}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Investors</div>
                                <div class="detail-value">${investors}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Portfolio Size</div>
                                <div class="detail-value">${portfolioSize}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Avg. Portfolio/User</div>
                                <div class="detail-value">${avgPortfolioPerUser}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            showFundNotFound(code, date) {
                this.contentDiv.innerHTML = `
                    <div class="fund-not-found">
                        Fund "${code}" not found for date ${date}
                    </div>
                `;
            }

            showLoading() {
                this.contentDiv.innerHTML = `
                    <div class="loading">
                        <p>Loading fund data...</p>
                    </div>
                `;
            }

            showMessage(message) {
                this.contentDiv.innerHTML = `
                    <div class="loading">
                        <p>${message}</p>
                    </div>
                `;
            }

            showError(message) {
                this.contentDiv.innerHTML = `
                    <div class="error">
                        ${message}
                    </div>
                `;
            }

            formatNumber(num) {
                if (!num) return '0';
                return parseFloat(num).toLocaleString();
            }

            formatCurrency(amount) {
                if (!amount) return '₺0';
                return '₺' + parseFloat(amount).toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new TefasFundViewer();
        });
    </script>
</body>
</html>
